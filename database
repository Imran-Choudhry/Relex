<?php
// database/migrations/2024_01_01_000001_create_users_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

class CreateUsersTable extends Migration
{
    public function up()
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            
            // System Identity
            $table->string('system_code', 20)->unique();
            $table->enum('role', ['super_admin', 'manager', 'provider', 'client']);
            
            // Encrypted Identity
            $table->text('real_name_encrypted')->nullable();
            $table->string('real_name_iv')->nullable();
            
            // Authentication
            $table->string('password');
            $table->string('pin_hash', 255)->nullable();
            $table->string('two_factor_secret')->nullable();
            $table->boolean('two_factor_enabled')->default(false);
            
            // Hierarchy
            $table->string('parent_code', 20)->nullable();
            $table->string('created_by', 20)->nullable();
            
            // Wallet
            $table->decimal('wallet_balance', 12, 2)->default(0);
            $table->decimal('wallet_hold', 12, 2)->default(0);
            
            // Status
            $table->boolean('is_active')->default(true);
            $table->timestamp('last_login_at')->nullable();
            
            $table->rememberToken();
            $table->timestamps();
            
            // Indexes
            $table->index('role');
            $table->index('parent_code');
            $table->index('created_by');
            $table->index('system_code');
        });
        
        // Add foreign key constraints
        DB::statement('ALTER TABLE users ADD CONSTRAINT fk_parent_code FOREIGN KEY (parent_code) REFERENCES users(system_code) ON DELETE RESTRICT');
        DB::statement('ALTER TABLE users ADD CONSTRAINT fk_created_by FOREIGN KEY (created_by) REFERENCES users(system_code) ON DELETE SET NULL');
    }
    
    public function down()
    {
        Schema::dropIfExists('users');
    }
}
